<?xml version="1.0" encoding="UTF-8"?>
<definition xmlns="http://workflow.opencastproject.org">

  <id>production</id>
  <title>Adaptive Streaming Workflow</title>
  <tags>
    <tag>upload</tag>
    <tag>schedule</tag>
  </tags>
  <displayOrder>100</displayOrder>
  <description>
    A workflow encoding into different qualities for adaptive streaming.
  </description>

  <configuration_panel>
    <![CDATA[
      <div id="workflow-configuration">
        <ul>
          <li>
            <input id="publish" name="publish" type="checkbox" class="configField" value="true" checked=checked />
            <label for="publish">Immediately distribute the recordings</label>
          </li>
        </ul>
      </div>
    ]]>
  </configuration_panel>

  <operations>

    <operation
      id="defaults"
      description="Applying default configuration values">
      <configurations>
        <configuration key="publish">true</configuration>
      </configurations>
    </operation>

    <!-- apply acl from series to the mediapackage -->
    <operation
        id="series"
        exception-handler-workflow="partial-error"
        description="Applying access control entries from series">
      <configurations>
        <configuration key="apply-acl">true</configuration>
      </configurations>
    </operation>

    <!-- tag all assets to be archived. this is quite unnecessary for this workflow but the default publish workflow
         expects the assets to be tagged and will fail due to no dublincore/episode catalog being archives which is a
         requirement of the archive workflow operation. hence, we do this extra work and get the compatibility in return. -->
    <operation
        id="tag"
        exception-handler-workflow="partial-error"
        description="Tagging media package elements for archival">
      <configurations>
        <configuration key="source-flavors">*/*</configuration>
        <configuration key="target-tags">+archive</configuration>
      </configurations>
    </operation>

    <!-- inspect media -->
    <operation
        id="inspect"
        exception-handler-workflow="partial-error"
        description="Inspecting audio and video streams">
      <configurations>
        <configuration key="overwrite">false</configuration>
        <configuration key="accept-no-media">false</configuration>
      </configurations>
    </operation>

    <!-- encode video -->
    <operation
        id="encode"
        exception-handler-workflow="partial-error"
        description="Encoding video">
      <configurations>
        <configuration key="source-flavor">*/source</configuration>
        <configuration key="target-flavor">*/preview</configuration>
        <configuration key="target-tags">preview</configuration>
        <configuration key="encoding-profile">prod.preview</configuration>
      </configurations>
    </operation>

    <!-- generate waveform -->
    <operation
        id="waveform"
        fail-on-error="false"
        description="Generating waveform">
      <configurations>
        <configuration key="source-flavor">*/preview</configuration>
        <configuration key="target-flavor">*/waveform</configuration>
        <configuration key="target-tags">preview</configuration>
      </configurations>
    </operation>

    <!-- publish preview -->
    <operation
      id="publish-configure"
      exception-handler-workflow="partial-error"
      description="Publish to preview publication channel">
      <configurations>
        <configuration key="source-tags">preview</configuration>
        <configuration key="channel-id">internal</configuration>
        <configuration key="url-pattern">http://localhost:8080/admin-ng/index.html#/events/events/${event_id}/tools/editor</configuration>
        <configuration key="check-availability">true</configuration>
      </configurations>
    </operation>

    <!-- encode publication video (presenter) -->
    <operation
      id="encode"
      if="${publish}"
      exception-handler-workflow="partial-error"
      description="Encoding video">
      <configurations>
        <configuration key="source-flavor">presenter/source</configuration>
        <configuration key="target-flavor">*/delivery</configuration>
        <configuration key="target-tags">engage-download,engage-streaming</configuration>
        <configuration key="encoding-profile">prod.dist.presenter</configuration>
      </configurations>
    </operation>

    <!-- encode publication video (presentation) -->
    <operation
      id="encode"
      if="${publish}"
      exception-handler-workflow="partial-error"
      description="Encoding video">
      <configurations>
        <configuration key="source-flavor">presentation/source</configuration>
        <configuration key="target-flavor">*/delivery</configuration>
        <configuration key="target-tags">engage-download,engage-streaming</configuration>
        <configuration key="encoding-profile">prod.dist.presentation</configuration>
      </configurations>
    </operation>

    <!-- encode to engage search result thumbnails -->
    <operation
      id="image"
      if="${publish}"
      exception-handler-workflow="partial-error"
      description="Create search result thumbnails">
      <configurations>
        <configuration key="source-flavor">*/preview</configuration>
        <configuration key="target-flavor">*/search+preview</configuration>
        <configuration key="target-tags">engage-download</configuration>
        <configuration key="encoding-profile">search-cover.http</configuration>
        <configuration key="time">1</configuration>
      </configurations>
    </operation>

    <!-- encode to engage player preview images -->
    <operation
        id="image"
        if="${publish}"
        exception-handler-workflow="partial-error"
        description="Create player preview image">
      <configurations>
        <configuration key="source-flavor">*/preview</configuration>
        <configuration key="target-flavor">*/player+preview</configuration>
        <configuration key="target-tags">engage-download</configuration>
        <configuration key="encoding-profile">player-preview.http</configuration>
        <configuration key="time">1</configuration>
      </configurations>
    </operation>

    <!-- run video segmentation -->
    <operation
        id="segment-video"
        if="${publish}"
        fail-on-error="false"
        exception-handler-workflow="partial-error"
        description="detecting slide transitions in presentation track">
      <configurations>
        <configuration key="source-flavor">presentation/preview</configuration>
        <configuration key="target-tags">engage-download</configuration>
      </configurations>
    </operation>

    <!-- generate segment preview images -->
    <operation
        id="segmentpreviews"
        if="${publish}"
        fail-on-error="false"
        exception-handler-workflow="partial-error"
        description="Creating presentation segments preview image">
      <configurations>
        <configuration key="source-flavor">presentation/preview</configuration>
        <configuration key="target-flavor">presentation/segment+preview</configuration>
        <configuration key="reference-flavor">presentation/preview</configuration>
        <configuration key="reference-tags">engage-download</configuration>
        <configuration key="target-tags">engage-download</configuration>
        <configuration key="encoding-profile">player-slides.http</configuration>
      </configurations>
    </operation>

    <!-- generate timeline preview images -->
    <operation
        id="timelinepreviews"
        if="${publish}"
        fail-on-error="false"
        exception-handler-workflow="error"
        description="Creating timeline preview images">
      <configurations>
        <configuration key="source-flavor">*/preview</configuration>
        <configuration key="target-flavor">*/timeline+preview</configuration>
        <configuration key="target-tags">engage-download</configuration>
        <configuration key="image-count">100</configuration>
      </configurations>
    </operation>

    <!-- extract text form slide preview images -->
    <operation
        id="extract-text"
        if="${publish}"
        fail-on-error="false"
        exception-handler-workflow="partial-error"
        description="Extracting text from presentation segments">
      <configurations>
        <configuration key="source-flavor">presentation/preview</configuration>
        <configuration key="target-tags">engage-download</configuration>
      </configurations>
    </operation>

    <!-- publish to engage player -->
    <operation
        id="publish-engage"
        if="${publish}"
        max-attempts="2"
        exception-handler-workflow="partial-error"
        description="Publishing to Engage">
      <configurations>
        <configuration key="download-source-flavors">dublincore/*,security/*</configuration>
        <configuration key="download-source-tags">engage-download</configuration>
        <configuration key="streaming-source-tags">engage-streaming</configuration>
        <configuration key="check-availability">true</configuration>
      </configurations>
    </operation>

    <!-- publish to oai-pmh -->
    <operation
        id="publish-oaipmh"
        if="${publish}"
        exception-handler-workflow="partial-error"
        description="Publish to OAI-PMH Default Repository">
      <configurations>
        <configuration key="download-flavors">dublincore/*,security/*</configuration>
        <configuration key="download-tags">engage-download</configuration>
        <configuration key="streaming-tags">engage-streaming</configuration>
        <configuration key="check-availability">true</configuration>
        <configuration key="repository">default</configuration>
      </configurations>
    </operation>

    <!-- archive the current state of the media package -->
    <operation
        id="snapshot"
        exception-handler-workflow="partial-error"
        description="Archiving">
      <configurations>
        <configuration key="source-tags">archive</configuration>
      </configurations>
    </operation>

    <!-- Cleanup the working file repository -->

    <operation
        id="cleanup"
        fail-on-error="false"
        description="Cleaning up">
      <configurations>
        <configuration key="preserve-flavors">security/*</configuration>
        <configuration key="delete-external">true</configuration>
      </configurations>
    </operation>

  </operations>

</definition>
